//-----------------------------------------------------------------------------
//!
//!	@file	ShadowMap.h
//!	@brief	シャドウマップ(1テクスチャ分)
//!	@author	YukiIshigaki
//!
//-----------------------------------------------------------------------------
#include "Library.h"

//-----------------------------------------------------------------------------
//! コンストラクタ
//-----------------------------------------------------------------------------
ShadowMap::ShadowMap()
: _shadowTexSize(Size<s32>(DEPTH_SIZE, DEPTH_SIZE))
{
}

//-----------------------------------------------------------------------------
//! デストラクタ
//-----------------------------------------------------------------------------
ShadowMap::~ShadowMap()
{
}


//-----------------------------------------------------------------------------
//! デプスマトリックスの計算
//-----------------------------------------------------------------------------
void ShadowMap::begin(LightBase* pLight, Matrix& depthMVP, Float2& offset)
{
	
	//-------------------------------------------------------------
	// 各種設定
	//-------------------------------------------------------------
	// 陰面処理有効化
	glEnable(GL_DEPTH_TEST);
	glDepthMask(GL_TRUE);
	//// カリング有効化
	//glEnable(GL_CULL_FACE);
	//// カリング面設定
	//glCullFace(GL_FRONT);
	// デプス方法設定
	glDepthFunc(GL_LESS);
	// ポリゴンをずらす
	glPolygonOffset( 1.0f, 4096.0f );
	glEnable(GL_POLYGON_OFFSET_FILL);

	//-------------------------------------------------------------
	// 光源の視点からModelViewProjMatrix転送
	//-------------------------------------------------------------

	// シェーダに転送
	GmShader()->setMatrix4x4("depthMVP", 1, GL_FALSE, (GLfloat*)&depthMVP._m[0]);

	//-------------------------------------------------------------
	// 描画範囲変更
	//-------------------------------------------------------------
	
	glViewport((GLint)offset._x, (GLint)offset._y, (GLsizei)_shadowTexSize._w, (GLsizei)_shadowTexSize._h);

}

//-----------------------------------------------------------------------------
//! シャドウ処理終了
//-----------------------------------------------------------------------------
void ShadowMap::end()
{
	// 書き込み終了処理(影を落とすために使っていたポリゴンのオフセットを戻す)
	glDisable(GL_POLYGON_OFFSET_FILL);
}


//=============================================================================
//	END OF FILE
//=============================================================================